name: Build and Release Flutter APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.4'
        channel: stable

    - name: Verify Flutter and Dart versions
      run: |
        flutter --version
        dart --version

    - name: Install dependencies
      run: flutter pub get

    # ðŸ”¹ Ambil versi (format: 1.0.1)
    - name: Get version from pubspec.yaml
      id: version
      run: |
        VERSION_LINE=$(grep "^version:" pubspec.yaml)
        VERSION=${VERSION_LINE#version: }
        VERSION=$(echo $VERSION | xargs)

        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "APK_NAME=aplikasiku-$VERSION.apk" >> $GITHUB_OUTPUT
        echo "TAG_NAME=v$VERSION" >> $GITHUB_OUTPUT

    - name: Build APK Release
      run: flutter build apk --release

    - name: Rename APK
      run: |
        mv build/app/outputs/flutter-apk/app-release.apk \
           ${{ steps.version.outputs.APK_NAME }}
        ls -la

    # ðŸ”¹ Hapus release lama jika tag sama
    - name: Delete existing release if exists
      run: |
        TAG="${{ steps.version.outputs.TAG_NAME }}"
        gh release delete "$TAG" --repo "${{ github.repository }}" --yes || true
        git tag -d "$TAG" || true
        git push origin ":refs/tags/$TAG" || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ðŸ”¹ Create GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.TAG_NAME }}
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## ðŸš€ Aplikasiku v${{ steps.version.outputs.VERSION }}

          ### ðŸ“± Download
          - **APK:** ${{ steps.version.outputs.APK_NAME }}

          ### âœ¨ What's New
          - Bug fixes & improvements
        files: |
          ${{ steps.version.outputs.APK_NAME }}

    # ðŸ”¹ Update versi ke backend (Lumen)
    - name: Update Version via Lumen API
      run: |
        curl -X POST ${{ secrets.API_BASE_URL }}/api/version/update \
          -H "Authorization: Bearer ${{ secrets.API_KEY }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"platform\": \"android\",
            \"version\": \"${{ steps.version.outputs.VERSION }}\"
          }"
